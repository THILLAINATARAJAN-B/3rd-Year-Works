<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Data Visualization and Analysis</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .chart-container {
            width: 100%;
            height: 400px;
            margin-bottom: 20px;
        }
        .filter-container {
            margin-bottom: 15px;
        }
        .table-container {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-3">
        <h1 class="text-center mb-4">Advanced Data Visualization and Analysis</h1>
        <div class="row">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Data Upload</h5>
                        <form id="upload-form" enctype="multipart/form-data">
                            <div class="form-group">
                                <input type="file" name="file" class="form-control-file" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Upload</button>
                        </form>
                    </div>
                </div>

                <div class="mt-3">
                    <h5>Cleaning Options</h5>
                    <form id="clean-form">
                        <div class="form-group">
                            <input type="checkbox" id="remove-duplicates" name="remove_duplicates">
                            <label for="remove-duplicates">Remove Duplicates</label>
                        </div>
                        <div class="form-group">
                            <input type="checkbox" id="drop-na" name="drop_na">
                            <label for="drop-na">Drop Missing Values</label>
                        </div>
                        <button type="submit" class="btn btn-secondary">Clean Data</button>
                    </form>
                </div>

                <div id="filters" class="mt-3"></div>
                <button id="update-charts" class="btn btn-success mt-3">Update Charts</button>
                <button id="download-report" class="btn btn-info mt-3">Download Report</button>
                
                <div class="card mt-3">
                    <div class="card-body">
                        <h5 class="card-title">Data Analysis</h5>
                        <div class="form-group">
                            <label for="analysis-type">Analysis Type</label>
                            <select id="analysis-type" class="form-control">
                                <option value="summary">Summary Statistics</option>
                                <option value="correlation">Correlation</option>
                                <option value="ttest">T-Test</option>
                                <option value="regression">Regression</option>
                                <option value="clustering">Clustering</option>
                                <option value="time_series">Time Series</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="column1">Column 1</label>
                            <select id="column1" class="form-control"></select>
                        </div>
                        <div class="form-group">
                            <label for="column2">Column 2</label>
                            <select id="column2" class="form-control"></select>
                        </div>
                        <button id="run-analysis" class="btn btn-primary">Run Analysis</button>
                    </div>
                </div>
            </div>

            <div class="col-md-9">
                <div class="table-container">
                    <div id="raw-data"></div>
                </div>
                <div class="table-container">
                    <div id="cleaned-data"></div>
                </div>
                <div id="charts"></div>
                <div id="analysis-results" class="mt-3"></div>
            </div>
        </div>
        <div class="col-md-9">
            <div class="table-container">
                <h5>Raw Data</h5>
                <div id="raw-data"></div>
            </div>
            <div class="table-container">
                <h5>Cleaned Data</h5>
                <div id="cleaned-data"></div>
            </div>
            <div id="charts"></div>
            <div id="analysis-results" class="mt-3"></div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            let columnData = {};

            $('#upload-form').submit(function(e) {
                e.preventDefault();
                let formData = new FormData(this);
                $.ajax({
                    url: '/upload',
                    type: 'POST',
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function(response) {
                        $('#raw-data').html(response.raw_data);
                        populateFilters(response.columns, response.column_data);
                        populateColumnSelects(response.columns);
                        columnData = response.column_data;
                    },
                    error: function(error) {
                        alert('Error uploading file: ' + error.responseJSON.error);
                    }
                });
            });

            $('#clean-form').submit(function(e) {
                e.preventDefault();
                let cleanOptions = {
                    remove_duplicates: $('#remove-duplicates').is(':checked'),
                    drop_na: $('#drop-na').is(':checked')
                };
                $.ajax({
                    url: '/clean_data',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(cleanOptions),
                    success: function(response) {
                        $('#cleaned-data').html(response.cleaned_data);
                    },
                    error: function(error) {
                        alert('Error cleaning data: ' + error.responseJSON.error);
                    }
                });
            });

            $('#update-charts').click(function() {
                let filterValues = {};
                $('#filters select').each(function() {
                    filterValues[$(this).attr('name')] = $(this).val();
                });
                $.ajax({
                    url: '/generate_report',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(filterValues),
                    success: function(response) {
                        $('#charts').empty();
                        response.charts.forEach(function(chartJson, index) {
                            let chartDiv = $('<div>').addClass('chart-container').attr('id', 'chart-' + index);
                            $('#charts').append(chartDiv);
                            Plotly.newPlot('chart-' + index, JSON.parse(chartJson));
                        });
                    },
                    error: function(error) {
                        alert('Error generating charts: ' + error.responseJSON.error);
                    }
                });
            });

            $('#download-report').click(function() {
                window.location.href = '/download_report';
            });

            $('#run-analysis').click(function() {
                let analysisType = $('#analysis-type').val();
                let column1 = $('#column1').val();
                let column2 = $('#column2').val();
                $.ajax({
                    url: '/analyze',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        analysis_type: analysisType,
                        column1: column1,
                        column2: column2
                    }),
                    success: function(response) {
                        displayAnalysisResults(analysisType, response);
                    },
                    error: function(error) {
                        alert('Error running analysis: ' + error.responseJSON.error);
                    }
                });
            });

            function populateFilters(columns, columnData) {
                $('#filters').empty();
                columns.forEach(function(column) {
                    let filterContainer = $('<div>').addClass('filter-container');
                    let label = $('<label>').text(column);
                    let select = $('<select>').addClass('form-control').attr('name', column);
                    select.append($('<option>').val('All').text('All'));
                    columnData[column].forEach(function(value) {
                        select.append($('<option>').val(value).text(value));
                    });
                    filterContainer.append(label, select);
                    $('#filters').append(filterContainer);
                });
            }

            function populateColumnSelects(columns) {
                $('#column1, #column2').empty();
                columns.forEach(function(column) {
                    $('#column1, #column2').append($('<option>').val(column).text(column));
                });
            }

            function displayAnalysisResults(analysisType, results) {
                let resultsHtml = '<h4>Analysis Results</h4>';
                switch(analysisType) {
                    case 'summary':
                        resultsHtml += '<ul>';
                        for (let stat in results.summary) {
                            resultsHtml += `<li>${stat}: ${results.summary[stat]}</li>`;
                        }
                        resultsHtml += '</ul>';
                        break;
                    case 'correlation':
                        resultsHtml += `<p>Correlation coefficient: ${results.correlation}</p>`;
                        break;
                    case 'ttest':
                        resultsHtml += `<p>T-statistic: ${results.t_statistic}</p>`;
                        resultsHtml += `<p>P-value: ${results.p_value}</p>`;
                        break;
                    case 'regression':
                        resultsHtml += `<p>R-squared: ${results.r_squared}</p>`;
                        resultsHtml += `<p>Coefficient: ${results.coefficient}</p>`;
                        resultsHtml += `<p>Intercept: ${results.intercept}</p>`;
                        break;
                    case 'clustering':
                        resultsHtml += '<p>Clustering results:</p>';
                        resultsHtml += '<ul>';
                        results.centroids.forEach((centroid, index) => {
                            resultsHtml += `<li>Cluster ${index + 1} centroid: (${centroid[0].toFixed(2)}, ${centroid[1].toFixed(2)})</li>`;
                        });
                        resultsHtml += '</ul>';
                        break;
                    case 'time_series':
                        let trace = {
                            x: results.dates,
                            y: results.values,
                            type: 'scatter'
                        };
                        Plotly.newPlot('analysis-results', [trace]);
                        return;
                }
                $('#analysis-results').html(resultsHtml);
            }
            $('#clean-form').submit(function(e) {
                e.preventDefault();
                let cleanOptions = {
                    remove_duplicates: $('#remove-duplicates').is(':checked'),
                    drop_na: $('#drop-na').is(':checked')
                };
                $.ajax({
                    url: '/clean_data',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(cleanOptions),
                    success: function(response) {
                        $('#cleaned-data').html(response.cleaned_data);
                        dataIsCleaned = true;
                        alert('Data cleaned successfully. The cleaned data will be included in the downloaded report.');
                    },
                    error: function(error) {
                        alert('Error cleaning data: ' + error.responseJSON.error);
                    }
                });
            });

            $('#download-report').click(function() {
                if (!dataIsCleaned) {
                    if (confirm('The data has not been cleaned. Do you want to download the report with raw data only?')) {
                        window.location.href = '/download_report';
                    }
                } else {
                    window.location.href = '/download_report';
                }
            });
        });
    </script>
</body>
</html>